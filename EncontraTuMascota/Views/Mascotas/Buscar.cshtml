@model List<EncontraTuMascota.Models.Mascota>

@{
    ViewData["Title"] = "Buscar Mascotas";
    // Traemos las publicaciones que est√°n en el ViewBag (se cargan desde el controller)
    var publicaciones = ViewBag.Publicaciones as List<EncontraTuMascota.Models.Publicacion> ?? new();
}

@* 
    Ac√° es donde busc√°s mascotas perdidas.
    Pod√©s filtrar por ubicaci√≥n, sexo, raza y fecha. Los filtros se combinan para afinar la b√∫squeda.
*@
<div class="buscar-page">
    <div class="page-header">
        <h1>üîç Buscar mascotas perdidas</h1>
    </div>

    @* Si acab√°s de publicar una mascota, te sale este mensaje de √©xito *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success">
            @TempData["SuccessMessage"]
        </div>
    }

    @* Formulario de b√∫squeda con filtros *@
    <div class="search-section">
        <form method="get" asp-action="Buscar" class="search-form">
            @* Todos los filtros juntos en una caja *@
            <div class="filters-section">
                <div class="filters-group">
                    @* Primera l√≠nea: Ubicaci√≥n (50%) y Fecha (20%) *@
                    <div class="filter-row">
                        <div class="filter-item filter-ubicacion">
                            <label for="termino" class="filter-label">üìç Ubicaci√≥n:</label>
                            <input type="text" name="termino" id="termino" value="@ViewBag.Termino" 
                                   class="filter-input" placeholder="Buscar por calle o barrio" />
                        </div>

                        <div class="filter-item filter-fecha">
                            <label for="fechaDesde" class="filter-label">üìÖ Desde:</label>
                            <input type="date" name="fechaDesde" id="fechaDesde" value="@ViewBag.FechaDesde" 
                                   class="filter-input" placeholder="DD/MM/AA" />
                        </div>
                    </div>

                    @* Segunda l√≠nea: Sexo (con checkboxes inline), Raza (con selector inline) y Botones *@
                    <div class="filter-row filter-row-inline">
                        <div class="filter-group-inline">
                            <label class="filter-label-inline">‚ôÄÔ∏è‚ôÇÔ∏è Sexo:</label>
                            <div class="checkbox-group-horizontal">
                                @{
                                    var sexoMasculino = ViewBag.SexoMasculino as bool? ?? false;
                                    var sexoFemenino = ViewBag.SexoFemenino as bool? ?? false;
                                }
                                <label class="checkbox-label">
                                    <input type="checkbox" name="sexoMasculino" value="true" checked="@sexoMasculino" id="sexoMasculino" />
                                    Masculino
                                </label>
                                <label class="checkbox-label">
                                    <input type="checkbox" name="sexoFemenino" value="true" checked="@sexoFemenino" id="sexoFemenino" />
                                    Femenino
                                </label>
                            </div>
                        </div>

                        <div class="filter-group-inline">
                            <label for="raza" class="filter-label-inline">üêï Raza:</label>
                            <select name="raza" id="raza" class="filter-select-inline">
                                <option value="">Todas</option>
                                @{
                                    var razaSeleccionada = ViewBag.RazaSeleccionada as int?;
                                }
                                @foreach (var razaEnum in Enum.GetValues<EncontraTuMascota.Models.Raza>())
                                {
                                    var razaValor = (int)razaEnum;
                                    var isSelected = razaSeleccionada == razaValor;
                                    var displayName = razaEnum.ToString()
                                        .Replace("GoldenRetriever", "Golden Retriever")
                                        .Replace("PastorAleman", "Pastor Alem√°n")
                                        .Replace("YorkshireTerrier", "Yorkshire Terrier")
                                        .Replace("HuskySiberiano", "Husky Siberiano")
                                        .Replace("CockerSpaniel", "Cocker Spaniel");
                                    
                                    <option value="@razaValor" selected="@isSelected">@displayName</option>
                                }
                            </select>
                        </div>

                        <div class="filter-actions-inline">
                            <button type="submit" class="btn btn-primary btn-search">
                                <span>üîé</span> Buscar
                            </button>
                            <a asp-action="Buscar" class="btn btn-secondary btn-clear">
                                üßπ Limpiar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>

    @* Resultados de la b√∫squeda *@
    <div class="results-section">
        @if (Model != null && Model.Any())
        {
            @* Si hay resultados, los mostramos en cards *@
            <h2>Mascotas encontradas (@Model.Count)</h2>
            <div class="mascotas-grid">
                @foreach (var mascota in Model)
                {
                    // Buscamos la publicaci√≥n asociada a esta mascota
                    var publicacion = publicaciones.FirstOrDefault(p => p.MascotaId == mascota.Id);
                    
                    <div class="mascota-card">
                        @* Foto de la mascota *@
                        <div class="mascota-image">
                            @if (!string.IsNullOrEmpty(mascota.FotoUrl))
                            {
                                <img src="@mascota.FotoUrl" alt="Mascota encontrada" />
                            }
                            else
                            {
                                <div class="no-image">üì∑ Sin imagen</div>
                            }
                        </div>
                        
                        @* Info de la mascota *@
                        <div class="mascota-info">
                            <h3>@mascota.Ubicacion</h3>
                            <p class="mascota-details">
                                <span class="detail-item"><strong>Sexo:</strong> @mascota.Sexo.ToString()</span>
                                @* Ac√° reemplazamos los nombres de enum por los nombres bonitos *@
                                <span class="detail-item"><strong>Raza:</strong> @{
                                    var razaDisplay = mascota.Raza.ToString()
                                        .Replace("GoldenRetriever", "Golden Retriever")
                                        .Replace("PastorAleman", "Pastor Alem√°n")
                                        .Replace("YorkshireTerrier", "Yorkshire Terrier")
                                        .Replace("HuskySiberiano", "Husky Siberiano")
                                        .Replace("CockerSpaniel", "Cocker Spaniel");
                                }
                                @razaDisplay</span>
                                <span class="detail-item"><strong>Fecha:</strong> @mascota.FechaPublicacion.ToString("dd")/@mascota.FechaPublicacion.ToString("MM")/'@mascota.FechaPublicacion.ToString("yy")</span>
                            </p>
                            
                            @* Si hay publicaci√≥n, mostramos descripci√≥n y contacto *@
                            @if (publicacion != null)
                            {
                                <p class="descripcion">@publicacion.Descripcion</p>
                                <div class="contacto-box">
                                    <strong>üìû Contacto:</strong><br />
                                    @if (Context.Session.GetString("Usuario") != null)
                                    {
                                        @* Usuario logueado: mostrar datos sin blur *@
                                        <strong>Nombre:</strong> @mascota.NombreContacto<br />
                                        <strong>Tel√©fono:</strong> @mascota.TelefonoContacto<br />
                                        <strong>Email:</strong> @mascota.EmailContacto
                                    }
                                    else
                                    {
                                        @* Usuario no logueado: mostrar con blur *@
                                        <strong>Nombre:</strong> <span class="contacto-blur">@mascota.NombreContacto</span><br />
                                        <strong>Tel√©fono:</strong> <span class="contacto-blur">@mascota.TelefonoContacto</span><br />
                                        <strong>Email:</strong> <span class="contacto-blur">@mascota.EmailContacto</span>
                                        <div class="login-prompt">
                                            <p>üîí <a href="#" onclick="mostrarLogin(); return false;">Inici√° sesi√≥n</a> para ver los datos de contacto</p>
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (!string.IsNullOrWhiteSpace(ViewBag.Termino as string))
        {
            @* Si buscaste algo y no hay resultados *@
            <div class="no-results">
                <p>No se encontraron mascotas con el t√©rmino "<strong>@ViewBag.Termino</strong>"</p>
                <a asp-action="Buscar" class="btn btn-secondary">Ver todas</a>
            </div>
        }
        else
        {
            @* Si todav√≠a no hay ninguna mascota publicada *@
            <div class="no-results">
                <p>üêæ A√∫n no hay mascotas publicadas</p>
                <p>¬øEncontraste una mascota? <a asp-action="Publicar">Publ√≠cala ac√°</a></p>
            </div>
        }
    </div>
</div>

<script>
    // Hacer que los checkboxes de sexo sean mutuamente exclusivos
    document.addEventListener('DOMContentLoaded', function() {
        const sexoMasculino = document.getElementById('sexoMasculino');
        const sexoFemenino = document.getElementById('sexoFemenino');
        
        if (sexoMasculino && sexoFemenino) {
            sexoMasculino.addEventListener('change', function() {
                if (this.checked) {
                    sexoFemenino.checked = false;
                }
            });
            
            sexoFemenino.addEventListener('change', function() {
                if (this.checked) {
                    sexoMasculino.checked = false;
                }
            });
        }
        
        // Hacer que todo el input de fecha abra el calendario
        const fechaInput = document.getElementById('fechaDesde');
        if (fechaInput) {
            fechaInput.addEventListener('click', function(e) {
                // Si no se hizo click en el icono del calendario, lo abrimos program√°ticamente
                if (e.target === this) {
                    this.showPicker();
                }
            });
        }
    });
</script>
